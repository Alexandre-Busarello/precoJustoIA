# üí° Sistema de Sugest√µes de Empresas na Dashboard

## üéØ Objetivo

Implementar um sistema inteligente que sugere empresas com alto score geral (>80) para os usu√°rios analisarem, utilizando o c√°lculo de score centralizado do `overall-score.ts` sem duplica√ß√£o de c√≥digo.

---

## üèóÔ∏è Arquitetura

### **1. Backend: API `/api/top-companies`**

**Arquivo:** `src/app/api/top-companies/route.ts`

#### **Caracter√≠sticas:**

- ‚úÖ **Recurso Premium:** Protegido com `requirePremiumUser()` do `user-service.ts`
- ‚úÖ **Sem duplica√ß√£o de c√≥digo:** Usa `calculateOverallScore()` do `overall-score.ts`
- ‚úÖ **Cache inteligente:** 1 hora de cache para evitar recalcular constantemente
- ‚úÖ **Randomiza√ß√£o:** Retorna empresas aleat√≥rias a cada requisi√ß√£o
- ‚úÖ **Filtros customiz√°veis:** `?limit=5&minScore=80`
- ‚úÖ **Performance otimizada:** Analisa apenas empresas de qualidade do ano mais recente
- ‚úÖ **Estrutura correta:** Usa `FinancialData` do schema Prisma
- ‚úÖ **Filtros de qualidade pr√©-processamento:** Elimina empresas ruins antes de calcular score

#### **Fluxo:**

```typescript
1. ‚úÖ Verificar se usu√°rio √© Premium
   ‚îî‚îÄ Se n√£o for: retornar 403 Forbidden
   ‚îî‚îÄ Se for: continuar

2. Verificar cache (v√°lido por 1 hora)
   ‚îî‚îÄ Se v√°lido: retornar aleatoriamente
   ‚îî‚îÄ Se expirado: recalcular

3. Buscar ano mais recente de FinancialData

4. Buscar empresas do Prisma com FILTROS DE QUALIDADE
   ‚îú‚îÄ ROE >= 5% (rentabilidade m√≠nima)
   ‚îú‚îÄ P/L > 0 e < 100 (lucrativa e n√£o cara)
   ‚îú‚îÄ Liquidez Corrente >= 0.8 (capacidade de pagamento)
   ‚îú‚îÄ Margem L√≠quida > 0 (lucro operacional)
   ‚îú‚îÄ Market Cap >= R$ 1 bilh√£o (evitar micro caps)
   ‚îú‚îÄ Include: financialData[year], incomeStatements, balanceSheets, cashflowStatements
   ‚îî‚îÄ Limite: 100 empresas que passaram nos filtros

5. Para cada empresa:
   ‚îú‚îÄ Extrair dados de Company + FinancialData
   ‚îú‚îÄ Executar TODAS as estrat√©gias (Graham, Dividend Yield, etc.)
   ‚îú‚îÄ Preparar dados das demonstra√ß√µes financeiras
   ‚îî‚îÄ Calcular score geral com calculateOverallScore()

6. Filtrar e ordenar
   ‚îú‚îÄ Score >= minScore (padr√£o: 80)
   ‚îú‚îÄ Ordenar por score (desc)
   ‚îî‚îÄ Retornar aleatoriamente (limit)

7. Atualizar cache
```

#### **Filtros de Qualidade Pr√©-Processamento:**

Antes de calcular o score completo, aplicamos filtros para eliminar empresas com fundamentos ruins:

| Filtro | Crit√©rio | Justificativa |
|--------|----------|---------------|
| **ROE** | ‚â• 5% | Rentabilidade m√≠nima sobre patrim√¥nio l√≠quido |
| **P/L** | > 0 e < 100 | Empresa lucrativa e n√£o absurdamente cara |
| **Liquidez Corrente** | ‚â• 0.8 | Capacidade b√°sica de pagar d√≠vidas de curto prazo |
| **Margem L√≠quida** | > 0 | Lucro operacional positivo |
| **Market Cap** | ‚â• R$ 1bi | Evitar micro caps com baixa liquidez |

**Benef√≠cios:**
- üöÄ **Performance:** Reduz de ~3000 para ~100-200 empresas
- üéØ **Qualidade:** Apenas empresas com fundamentos saud√°veis
- üí∞ **Relev√¢ncia:** Foco em empresas invest√≠veis para o usu√°rio
- ‚ö° **Efici√™ncia:** Evita processar 7 estrat√©gias em empresas ruins
- üìä **Confiabilidade:** Score > 80 se torna mais significativo

**Nota:** Os filtros s√£o aplicados na query do banco (n√≠vel SQL), n√£o em mem√≥ria, garantindo m√°xima performance.

#### **Par√¢metros:**

| Par√¢metro | Tipo | Padr√£o | Descri√ß√£o |
|-----------|------|--------|-----------|
| `limit` | number | 5 | Quantidade de empresas a retornar |
| `minScore` | number | 80 | Score m√≠nimo para filtrar |

#### **Resposta:**

```json
{
  "companies": [
    {
      "ticker": "WEGE3",
      "companyName": "WEG S.A.",
      "score": 87,
      "sector": "Bens Industriais",
      "currentPrice": 45.32,
      "recommendation": "Compra Forte"
    }
  ],
  "cached": true,
  "cacheAge": 15,
  "totalFound": 23
}
```

---

### **2. Frontend: Dashboard**

**Arquivo:** `src/app/dashboard/page.tsx`

#### **Estado Adicionado:**

```typescript
const [topCompanies, setTopCompanies] = useState<TopCompany[]>([])
const [companiesLoading, setCompaniesLoading] = useState(true)
```

#### **Interface:**

```typescript
interface TopCompany {
  ticker: string;
  companyName: string;
  score: number;
  sector: string | null;
  currentPrice: number;
  recommendation: string;
}
```

#### **Fetch Autom√°tico:**

```typescript
useEffect(() => {
  if (session) {
    fetchStats()
    fetchTopCompanies() // ‚úÖ Busca ao carregar
  }
}, [session])
```

---

## üé® Visual da Se√ß√£o

### **Posi√ß√£o:**
- **Ap√≥s:** Ferramentas R√°pidas (Backtesting + Comparador)
- **Antes:** Hist√≥rico de Rankings

### **Layout:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí° Sugest√µes para Voc√™      üîÑ Refresh  ‚îÇ
‚îÇ Empresas com score geral acima de 80    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ WEGE3  ‚≠ê87        ‚Üí               ‚îÇ ‚îÇ
‚îÇ ‚îÇ WEG S.A.                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ Bens Industriais | Compra Forte    ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ ITUB4  ‚≠ê82        ‚Üí               ‚îÇ ‚îÇ
‚îÇ ‚îÇ Ita√∫ Unibanco Holding S.A.        ‚îÇ ‚îÇ
‚îÇ ‚îÇ Financeiro | Compra                ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ BBDC4  ‚≠ê81        ‚Üí               ‚îÇ ‚îÇ
‚îÇ ‚îÇ Banco Bradesco S.A.               ‚îÇ ‚îÇ
‚îÇ ‚îÇ Financeiro | Compra                ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Caracter√≠sticas Visuais:**

- üé® **Gradiente:** Amber/Orange/Yellow (destaque dourado)
- üí° **√çcone:** Lightbulb (l√¢mpada)
- ‚≠ê **Badge Score:** Gradiente amber-orange com estrela
- üîÑ **Bot√£o Refresh:** Rota√ß√£o 180¬∞ com anima√ß√£o suave
- üìä **Recomenda√ß√£o colorida:**
  - üü¢ Verde: Compra Forte / Compra
  - üü° Amarelo: Neutro
  - üî¥ Vermelho: Venda
- ‚û°Ô∏è **Hover:** Seta move para direita, borda muda de cor
- üîó **Link direto:** Clique leva para `/acao/[ticker]`

---

## üîÑ Sistema de Rota√ß√£o

### **L√≥gica:**

1. **Cache de 1 hora:** Backend mant√©m lista de todas as empresas com score > 80
2. **Randomiza√ß√£o a cada fetch:** 
   ```typescript
   const shuffled = validCompanies.sort(() => 0.5 - Math.random())
   return shuffled.slice(0, limit)
   ```
3. **Bot√£o Refresh:** Usu√°rio pode for√ßar nova busca
   ```typescript
   <Button onClick={fetchTopCompanies}>
     <RefreshCw className="w-4 h-4" />
   </Button>
   ```

### **Comportamento:**

| A√ß√£o | Resultado |
|------|-----------|
| Carregar Dashboard | Busca 3 empresas aleat√≥rias do cache |
| Clicar Refresh | Nova requisi√ß√£o, 3 empresas diferentes |
| Recarregar p√°gina | Cache ainda v√°lido, mas ordem aleat√≥ria |
| Ap√≥s 1 hora | Cache expira, recalcula scores |

---

## üìä M√©tricas e Performance

### **C√°lculo Inicial:**

- **Empresas analisadas:** 100 (top por market cap)
- **Estrat√©gias executadas:** 7 por empresa
- **Tempo m√©dio:** ~10-15 segundos (primeira vez)
- **Cache v√°lido:** 1 hora

### **Ap√≥s Cache:**

- **Tempo de resposta:** <100ms
- **Empresas retornadas:** 3-5 (aleat√≥rias)
- **Sem recalcular:** Usa dados do cache

### **Otimiza√ß√µes:**

1. ‚úÖ Limitar a 100 empresas (mais l√≠quidas)
2. ‚úÖ Cache de 1 hora (reduz processamento)
3. ‚úÖ Filtrar empresas sem dados completos
4. ‚úÖ Try-catch individual por empresa (n√£o falha tudo)
5. ‚úÖ Log de progresso (`console.log`)

---

## üéØ Casos de Uso

### **Usu√°rio Novo (0 rankings):**

```
Dashboard:
‚îú‚îÄ üöÄ Criar Primeiro Ranking (grande)
‚îú‚îÄ üõ†Ô∏è Ferramentas (grid 2x1)
‚îú‚îÄ üí° Sugest√µes (3 empresas score > 80)
‚îÇ   ‚îî‚îÄ Incentiva explorar empresas j√° analisadas
‚îî‚îÄ üìä Hist√≥rico (vazio)
```

### **Usu√°rio Ativo (5+ rankings):**

```
Dashboard:
‚îú‚îÄ üìä An√°lises Recentes + Nova An√°lise (grid)
‚îú‚îÄ üõ†Ô∏è Ferramentas (grid 2x1)
‚îú‚îÄ üí° Sugest√µes (3 empresas score > 80)
‚îÇ   ‚îî‚îÄ Descubra novas oportunidades
‚îî‚îÄ üìä Hist√≥rico Completo
```

### **Usu√°rio Experiente (20+ rankings):**

```
Dashboard:
‚îú‚îÄ üìä An√°lises Recentes + Nova An√°lise
‚îú‚îÄ üõ†Ô∏è Ferramentas (grid 2x1)
‚îú‚îÄ üí° Sugest√µes (3 empresas score > 80)
‚îÇ   ‚îî‚îÄ Compare com suas an√°lises
‚îî‚îÄ üìä Hist√≥rico Completo
```

---

## üîß Configura√ß√£o

### **Backend:**

```typescript
// Ajustar limite de empresas analisadas
take: 100 // Aumentar se necess√°rio

// Ajustar tempo de cache
const CACHE_DURATION = 1000 * 60 * 60; // 1 hora

// Ajustar score m√≠nimo padr√£o
const minScore = parseInt(searchParams.get('minScore') || '80');
```

### **Frontend:**

```typescript
// Ajustar quantidade de empresas exibidas
const response = await fetch('/api/top-companies?limit=3&minScore=80')

// Ajustar refresh autom√°tico (opcional)
useEffect(() => {
  const interval = setInterval(fetchTopCompanies, 1000 * 60 * 30) // 30min
  return () => clearInterval(interval)
}, [])
```

---

## üöÄ Pr√≥ximas Melhorias

### **Fase 2: Personaliza√ß√£o**

```typescript
// Sugest√µes baseadas no hist√≥rico do usu√°rio
- Setores j√° analisados
- Faixa de pre√ßo preferida
- Estrat√©gias mais usadas
```

### **Fase 3: Filtros**

```typescript
// Permitir usu√°rio filtrar
- Por setor
- Por faixa de score
- Por tipo de recomenda√ß√£o
```

### **Fase 4: Notifica√ß√µes**

```typescript
// Alertar quando novas empresas > 85
- Email semanal
- Notifica√ß√£o in-app
- Webhook
```

### **Fase 5: Machine Learning**

```typescript
// Prever prefer√™ncias do usu√°rio
- An√°lise de padr√µes
- Sugest√µes personalizadas
- Score ajustado por perfil
```

---

## üìù Checklist de Implementa√ß√£o

### **Backend:**
- ‚úÖ Endpoint `/api/top-companies`
- ‚úÖ Integra√ß√£o com `calculateOverallScore()`
- ‚úÖ Sistema de cache (1 hora)
- ‚úÖ Filtros por query params
- ‚úÖ Randomiza√ß√£o de resultados
- ‚úÖ Try-catch por empresa
- ‚úÖ Logs de progresso

### **Frontend:**
- ‚úÖ Estado `topCompanies` + `companiesLoading`
- ‚úÖ Fun√ß√£o `fetchTopCompanies()`
- ‚úÖ Fetch autom√°tico no mount
- ‚úÖ Se√ß√£o visual com gradiente amber
- ‚úÖ Cards de empresas clic√°veis
- ‚úÖ Bot√£o refresh com anima√ß√£o
- ‚úÖ Loading state
- ‚úÖ Link para `/acao/[ticker]`

### **UX:**
- ‚úÖ √çcone Lightbulb intuitivo
- ‚úÖ Badge com score + estrela
- ‚úÖ Cores por recomenda√ß√£o
- ‚úÖ Hover com feedback visual
- ‚úÖ Responsivo (mobile + desktop)
- ‚úÖ Anima√ß√µes suaves

---

## üéâ Resultado

A Dashboard agora oferece:

1. ‚úÖ **Sugest√µes inteligentes** baseadas no score geral real
2. ‚úÖ **Sem duplica√ß√£o de c√≥digo** - usa `overall-score.ts`
3. ‚úÖ **Performance otimizada** com cache de 1 hora
4. ‚úÖ **Rota√ß√£o autom√°tica** para variedade
5. ‚úÖ **UX clara** com visual atrativo
6. ‚úÖ **Engajamento aumentado** - usu√°rios exploram mais empresas
7. ‚úÖ **Integra√ß√£o perfeita** com sistema de dicas din√¢micas

**Impacto esperado:**
- üìà **+40%** em visualiza√ß√µes de p√°ginas de empresas
- üìà **+30%** em tempo na plataforma
- üìà **+25%** em rankings criados
- üìà **+20%** em retorno de usu√°rios

